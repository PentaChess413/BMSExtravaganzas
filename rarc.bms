# Ported from LagoLunatic's RARC parser for his gclib Python library, which is used in GCFT. 
# As of now, this was only tested in a single dir, fully uncompressed RARC with my Yay0 script.
# It should theoretically work with directories, but I haven't tested that just yet.
debug 1
endian big
idstring "RARC"
get size long
get dataHeaderOffset long
get dataListOffset long
math dataListOffset - 0x20
get dataSize long
get mramSize long
get aramSize long
get dvdSize long
goto dataHeaderOffset
get numNodes long
get nodeListOffset long
math nodeListOffset + dataHeaderOffset
get numTotalFiles long
get fileEntriesOffset long
math fileEntriesOffset + dataHeaderOffset
get stringTableSize long
get stringTableOffset long
math stringTableOffset + dataHeaderOffset
get freeFileId short
get syncId byte
startfunction extract idx
    print "%extract_arg1%"
    getarray isADirectory 10 extract_arg1
    if isADirectory = 1
        getarray dirName 9 extract_arg1
        if dirName != "." || dirName != ".."
            string subdirPath p "/%d" dirName
            getarray indexOfNode 11 extract_arg1
            callfunction extract extract_arg1
        endif
    endif
    getarray fileNameToLog 9 extract_arg1
    getarray sizeToLog 7 extract_arg1
    getarray dataOffsetToLog 13 extract_arg1
    log fileNameToLog dataOffsetToLog extract_arg1
endfunction
padding 5
for i = 0 < numNodes
    set curOffset nodeListOffset
    set tempI i
    math tempI * 0x10
    math curOffset + tempI
    goto curOffset
    getdstring type 4
    get nameOffset long
    get nameHash short
    get numFiles short
    get firstFileIndex long
    set curOffset2 stringTableOffset
    math curOffset2 + nameOffset
    goto curOffset2
    get name string
    putarray 0 -1 type
    putarray 1 -1 nameOffset
    putarray 2 -1 numFiles
    putarray 3 -1 firstFileIndex
    putarray 4 -1 name
next i
for i = 0 < numTotalFiles
    set fileEntryOffset fileEntriesOffset
    set tempI i
    math tempI * 0x14
    math fileEntryOffset + tempI
    goto fileEntryOffset
    get id short
    get hash short
    get typeAndNameOffset long
    get dataOffsetOrNodeIndex long
    get dataSize long
    set type typeAndNameOffset
    math type & 0xFF000000
    math type >> 24
    set nameOffset typeAndNameOffset
    math nameOffset & 0x00FFFFFF
    math nameOffset + stringTableOffset
    goto nameOffset
    get name string
    set isdir 0
    if type & 0x02 == 0
        set isdir 1
    endif
    if isdir == 1
        set nodeIndex dataOffsetOrNodeIndex
    else
        set dataOffset dataOffsetOrNodeIndex
        set absDataOffset dataListOffset
        math absDataOffset + dataOffset
        goto absDataOffset
        getdstring data dataSize
    endif
    putarray 5 -1 fileEntryOffset
    putarray 6 -1 id
    putarray 7 -1 dataSize
    putarray 8 -1 type
    putarray 9 -1 name
    putarray 10 -1 isdir
    if isdir == 1
        putarray 11 -1 nodeIndex
    else
        putarray 12 -1 data
        putarray 13 -1 absDataOffset
    endif
next i
getarray totalFiles 6 -0x80000000
print "%totalFiles%"
for i = 0 < totalFiles
    print "%i%"
    callfunction extract 0 i
next i